#!/bin/bash

# Convert _FILE style environment variables
while IFS='=' read -r n v; do
    str_arg="${n%_FILE}"
    if [ "$n" != "$str_arg" ]; then
        export "$str_arg"="$(cat $v)"
    fi
done <<< $(env)

python -m thepoint dumpdata -a --indent=2 --exclude auth.permission --exclude contenttypes | bzip2 | aws s3 cp - "s3://${BACKUP_BUCKET}/data.json.bz2" --quiet
aws s3 sync "s3://${MEDIAFILES_BUCKET}/" "s3://${BACKUP_BUCKET}/media/" --quiet --delete
