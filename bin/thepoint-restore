#!/bin/bash

# Convert _FILE style environment variables
while IFS='=' read -r n v; do
    str_arg="${n%_FILE}"
    if [ "$n" != "$str_arg" ]; then
        export "$str_arg"="$(cat $v)"
    fi
done <<< $(env)

if [ -z $MEDIAFILES_BUCKET ]; then
    MEDIA_DIR='./media/'
else
    MEDIA_DIR="s3://${MEDIAFILES_BUCKET}/"
fi

python -m thepoint shell -c "from django.core import management; management.call_command('migrate', verbosity=0, interactive=False); management.call_command('flush', verbosity=0, interactive=False, inhibit_post_migrate=True)"
aws s3 sync "s3://${BACKUP_BUCKET}/media/" $MEDIA_DIR --quiet --delete
aws s3 cp "s3://${BACKUP_BUCKET}/data.json.bz2" - --quiet | bunzip2 | DEBUG='' python -m thepoint loaddata --format json -
